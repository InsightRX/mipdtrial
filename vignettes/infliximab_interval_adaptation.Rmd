---
title: "Interval adaptation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Busulfan MIPD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this example script, we will run simulated MIPD trials were not the dose,
but rather the interval is modified. This can be relevant for many drugs, 
especially drugs with limited dose strength options.

For this example, we will use a PK model for infliximab by Fasanmade et al,
which was developed on a large cohort of patients. Infliximab is usually 
started using a 14-week induction phase followed by a maintenance phase, 
but for simplicity we will ignore the induction phase in this example and use 
only fixed maintenance dosing.

```{r setup}
library(mipdtrial)
if(!require(pkinfliximabfasanmade, warn.conflicts = FALSE)) {
  PKPDsim::install_default_literature_model("pk_infliximab_fasanmade")
  library(pkinfliximabfasanmade)
}

# For example data
library(NHANES)

# For data handling/plotting
library(dplyr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)

```

## 1. Define simulation parameters

Patients will be started on 5 mg/kg, doses every 8 weeks. Based on measured
trough levels and MAP-bayed dose adaptation we will allow for changes in the 
dosing interval to 4, 6, or 10 weeks. We will run the trial for 4 doses, and
take a TDM sample at the end of each dosing cycle.

```{r}
## TDM scheme
tdm_scheme <- create_sampling_scheme(
  time = c(-1, -1, -1, -1), # sample 1-hour before next dose
  offset_base = "trough",
  anchor = c(1, 2, 3, 4),
  anchor_by = "dose"
)
adjust_at_dose <- c(2, 3, 4)

## Target
target <- create_target_object(
  targettype = "cmin", 
  targetvalue = 7
)
```

## 2. Create a set of digital patient covariates

The Fasanmade model includes weight (WT), serum albumin (ALB) as covariates, as well as
the use of concomittant immunomodulatory drugs (IMM) and the development of 
antibodies against infliximab (ATI). 

For this simulation study, we will assume a multivariate distribution for WT
and ALB. We will assume all patients use concomittant immunomodulatory drugs, 
and assume 5% of patients will developed ATI (not correlated with weight or 
albumin)

```{r}
n_patients <- 100
means <- c(70, 45) # wt, albumin
covt_dist <- matrix(c(450, -15, 
                      -15, 30), byrow=T, ncol=2)
dat <- MASS::mvrnorm(n = n_patients, mu = means, Sigma = covt_dist) %>%
  data.frame() %>% 
  setNames(c("WT", "ALB")) %>%
  mutate(ALB = ALB / 10) %>% # model has ALB unit in mg/dL, not mg/L
  mutate(
    IMM = 1, 
    ATI = as.numeric(runif(n_patients) < 0.05),
    ID = 1:n_patients
  )
```

Here are the first few rows of our data set:

```{r}
head(dat)
```

We will also only look at the first 10 patients in our data set, in the 
interest of speed.

```{r}
ids <- dat$ID[1:10]
```

## 3. Load model definitions

We need to define the model parameters and variability terms for our simulation.
For this study, we will use the ones defined in the models, and we will use
the same model for simulation as for MAP estimation.

```{r}
model      <- pkinfliximabfasanmade::model()
parameters <- pkinfliximabfasanmade::parameters()
omega      <- pkinfliximabfasanmade::omega_matrix()
ruv        <- pkinfliximabfasanmade::ruv()
```

We gave the covariates in the dataset the exact names expected by the model
so we do not have map the covariates (how to use `cov_mapping` is shown in other 
vignettes).

## 4. Initialize output metrics of interest

We want to record both "true" trough concentration and estimated trough, 
along with patient identifiers (i.e., `id`).

```{r}
comb <- c()
```

## 5. Simulate a trial!

Each patient will start at a dose of 5 mg/kg body weight given every 8 weeks. 

We will then use sample troughs, perform MAP estimations, and use 
`mipdtrial::interval_grid_search` to optimize intervals to attain a target of 
7 mg/L.

```{r dose-adapt}
set.seed(123) # important for reproducibility
for (i in ids) {
  
  # get patient covariates
  covs <- create_cov_object(
    dat[dat$ID == i,], 
    mapping = c(WT = "WT", ALB = "ALB", ATI = "ATI", IMM = "IMM")
  )
  # create initial dosing regimen (see PKPDsim::new_regimen for more info)
  reg <- PKPDsim::new_regimen(
    amt = 5 * covs$WT$value, # we will update this each "day" of the trial.
    interval = 8 * 7 * 24,
    n = 5,
    t_inf = 2,
    type = "infusion"
  )
  cmin_times <- reg$dose_times[5] + 24 * 7 * 8
  
  # randomly draw individual PK parameters
  pars_true_i <- generate_iiv(
    sim_model = model,
    omega = omega,
    parameters = parameters
  )
  
  treatment_summary <- sample_and_adjust_by_dose(
    adjust_at_dose  = adjust_at_dose, 
    sampling_scheme = tdm_scheme,
    regimen         = reg,
    covariates      = covs,
    pars_true_i     = pars_true_i,
    sim_model       = model,
    sim_ruv         = ruv,
    est_model       = model,
    parameters      = parameters,
    omega           = omega,
    ruv             = ruv,
    target_time     = cmin_times,
    target          = target,
    dose_optimization_method = dose_adjust_map,
    max_dose = 2900,
    verbose = T
  )
  
  # extract metrics of interest
  comb <- bind_rows(
    comb,
    treatment_summary$tdms %>%
      mutate(
        id = i, 
        new_dose = treatment_summary$dose_updates$new_dose
      )
  )
}
```

Here are the first few rows of our simulation results:

```{r}
head(comb)
```

## 6. Analyze results for dose-adaptation

```{r}
ggplot(comb, aes(x = t / (24*7), y = y, group = id)) +
  geom_line() +
  geom_point() +
  xlab("Weeks") + ylab("Trough concentration (mg/L)")
```

## 7. Run same simulatin but now for interval adaptation

```{r interval-adapt}
set.seed(1) # same set of patients
for (i in ids) {
  
  # get patient covariates
  covs <- create_cov_object(
    dat[dat$ID == i,], 
    mapping = c(WT = "WT", ALB = "ALB", ATI = "ATI", IMM = "IMM")
  )
  # create initial dosing regimen (see PKPDsim::new_regimen for more info)
  reg <- PKPDsim::new_regimen(
    amt = 5 * covs$WT$value, # we will update this each "day" of the trial.
    interval = 8 * 7 * 24,
    n = 5,
    t_inf = 2,
    type = "infusion"
  )
  
  # randomly draw individual PK parameters
  pars_true_i <- generate_iiv(
    sim_model = model,
    omega = omega,
    parameters = parameters
  )
  
  treatment_summary <- sample_and_adjust_by_dose(
    adjust_at_dose  = adjust_at_dose, 
    sampling_scheme = tdm_scheme,
    regimen         = reg,
    covariates      = covs,
    pars_true_i     = pars_true_i,
    sim_model       = model,
    sim_ruv         = ruv,
    est_model       = model,
    parameters      = parameters,
    omega           = omega,
    ruv             = ruv,
    target_time     = cmin_times,
    target          = target,
    dose_optimization_method = interval_adjust_map,
    interval_grid = c(4, 6, 8, 10, 12),
    verbose = F
  )
  
  # extract metrics of interest
  comb <- bind_rows(
    comb,
    treatment_summary$tdms %>%
      mutate(
        id = i, 
        new_dose = reg$dose_amts[adjust_at_dose]
      )
  )
}
```
