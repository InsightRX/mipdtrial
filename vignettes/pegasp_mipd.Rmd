---
title: "Custom initial dose nomogram, a PEG Asparaginase case study"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PEG Asparaginase}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE, 
  message = FALSE
)
ggplot2::theme_set(ggplot2::theme_minimal())
ggplot2::theme_update(
  axis.line.x.bottom = ggplot2::element_line(colour = "black"),
  panel.grid.major.x = ggplot2::element_blank()
)
```

```{r echo=FALSE,results='hide'}
# for CI, most windows users should not need this since the .libPaths should
# include where the model was installed.
if (.Platform$OS.type == "windows") { 
    .libPaths(c("D:/a/mipdtrial/mipdtrial/check/mipdtrial.Rcheck", .libPaths()))
}
if(!require(pkpegasparaginasemodifiedwurthwein, warn.conflicts = FALSE)) {
  PKPDsim::install_default_literature_model("pk_pegasparaginase_modified_wurthwein")
}
```

In this vignette, we will demonstrate the following tools:

- using {mipdtrial} to simulate a trial, with the trial design specified using
  R code.
- writing a custom function to handle initial dosing.

```{r setup}
library(mipdtrial)
library(PKPDsim) # for working with models
if(!require(pkpegasparaginasemodifiedwurthwein, warn.conflicts = FALSE)) {
  install_default_literature_model("pk_pegasparaginase_modified_wurthwein")
}
library(NHANES) # for example data

# For data handling/plotting
library(dplyr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)

```

## 1. Define simulation parameters

Initial dosing algorithms must return a PKPDsim-style regimen object, and have
access to three objects:

- `covariates`: patient-level covariates
- `design`: a named list of PKPDsim-style covariates (created with `create_trial_design`)
- `cov_mapping`: described later in this vignette

Initial PEG-asparaginase dosing is 2500 IU/m2 for patients older than 22 years
(inclusive) and 2000 IU/m2 for patients younger than 22 years (exclusive), with
doses capped at a maximum total dose of 3750 IU. For our nomogram, we only need
the information stored in `covariates`. Let's define this function:

```{r}
asp_nomogram <- function(covariates, ...) {
  if (covariates$AGE$value >= 22) {
    dose <- 2500 * covariates$BSA$value
  } else {
    dose <- 2000 * covariates$BSA$value
  }

  # cap dose to a maximum of 3750
  dose <- pmin(dose, 3750)
  
  # create initial dosing regimen (see PKPDsim::new_regimen for more info)
  PKPDsim::new_regimen(
    amt = dose, 
    interval = 14 * 24, # 14 days, converted to hours
    n = 5,
    t_inf = 1,
    type = "infusion"
  )
}
```

PEG-asparaginase has a long half-life. In this simulation trial, patients 
will receive 4 doses separated by 14 days levels collected every 14 days just 
prior to the next dose. We will adjust doses 2 and 3 to achieve a steady state 
asparaginase activity level of of 300 IU/L (0.3 IU/mL) (goal: 0.1 - 0.5 IU/mL)

```{r}
tdm_design <- create_sampling_design(
  time = c(13.9*24,  27.9*24,  41.9*24)
)

update_design <- create_regimen_update_design(
  at = c(2, 3),
  anchor = "dose",
  dose_optimization_method = map_adjust_dose
)

target_design <- create_target_design(
  targettype = "cmin", 
  targetvalue = 300,
  at = 4,
  anchor = "dose"
)

model_design <- create_model_design(lib = "pkpegasparaginasemodifiedwurthwein")

initial_method <- create_initial_regimen_design(method = asp_nomogram)

design <- create_trial_design(
  sampling_design = tdm_design,
  target_design = target_design,
  regimen_update_design = update_design,
  initial_regimen_design = initial_method,
  sim_design = model_design, est_design = model_design
)
```

## 2. Create a set of digital patient covariates

For this example we use the `NHANES::NHANES` synthetic data set, based on CDC growth curves of children. While the original data set is much larger, here we will take just the first
20 patients to reduce computation time. 

```{r}
# FIXME: The data wrangling here distracts from the purpose of this vignette. My
# suggestion would be to include this 20 patient data set in mipdtrial, so you can
# replace this code chunk with a one-liner like: mipdtrial::NHANES20 
dat <- NHANES::NHANES |>
  # take just the first record per patient
  group_by(ID) |>
  slice(1) |>
  ungroup() |>
  # convert columns to numeric
  mutate(Sex = if_else(Gender == "male", 1, 0)) |> # as defined in models
  filter(Age < 18) |>
  select(ID, Sex, Age, Weight, Height) |>
  mutate(BSA = sqrt(Weight * Height / 3600)) |> 
  # include only patients with all information available
  na.omit() |> 
  head(n = 20)

dat
```

We also need to link the covariates in our data set to the covariates expected
in the model:

  - To check which covariates are required for your model use `PKPDsim::get_model_covariates()`:

    ```{r}
    # FIXME: This does not have the same covariates as colnames(). Missing BSA.
    get_model_covariates(model_design$model)
    ```
  
  - To check which covariates are in your data set use `colnames()`:

    ```{r}
    colnames(dat)
    ```

After checking the covariates, we can link them in a named character vector, where the model covariates are names and the data covariates are values.

```{r}
cov_map <- c(
  AGE = "Age", 
  WT = "Weight", 
  HT = "Height", 
  BSA = "BSA",
  SEX = "Sex"
)
```

## 3. Simulate a trial!

To run our trial, we just call `run_trial()`! This function does a lot under-the-
hood.

For inter-individual variability terms, we will use the inter-individual
variability described by our model, since this should reflect the distribution 
in patient pharmacokinetics. Later, we will estimate the individual PK 
parameters using our estimation model and the measured TDMs we "collect".

For residual error terms, we will use the residual error of our model,
since this is supposed to reflect the unexplained error (assay error, 
etc.). This function creates a data frame of error to add to each simulated 
concentrations <!-- FIXME: typo? should be singular? --> to produced a measured therapeutic drug monitoring sample.

```{r}
res <- run_trial(data = dat, design = design, cov_mapping = cov_map, seed = 1)
```

Here are the first few rows of our simulation results:

```{r}
head(res$final_exposure)
```

## 4. Analyze results

How well did our patients get to target?

```{r fig.width = 2, fig.height = 4}
res$final_exposure |> 
  pivot_longer(-id, names_to = "conc_type", values_to = "conc") |> 
  ggplot(aes(x = conc_type, y = conc)) +
    geom_rect(
      aes(
        xmin = -Inf, xmax = Inf, 
        ymin = target_design$min, ymax = target_design$max,
      ),
      fill = "grey80"
    ) +
    geom_boxplot() +
    coord_cartesian(ylim = c(0, target_design$max * 1.3)) +
    labs(
      x = "Concentration type",
      y = "Final concentration after MIPD (IU/L)"
    )
```

While further work is needed to establish a realistic upper toxicity threshold
to inform the therapeutic window of PEG-asparaginase, an MIPD approach informed
by AAL levels which are already germane to therapeutic care with
PEG-asparaginase may translate to better target attainment and cost savings. For
further details, see [Brooks et al., PAGE Meeting; June 26-28, 2024, Rome,
Italy.](https://www.page-meeting.org/default.asp?abstract=10796).
