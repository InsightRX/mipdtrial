<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mipdtrial">
<title>Busulfan MIPD • mipdtrial</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Busulfan MIPD">
<meta property="og:description" content="mipdtrial">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mipdtrial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/busulfan_mipd.html">Busulfan MIPD</a>
    <a class="dropdown-item" href="../articles/sample_timing.html">Effect of sample timing</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Busulfan MIPD</h1>
            
      
      
      <div class="d-none name"><code>busulfan_mipd.Rmd</code></div>
    </div>

    
    
<p>In this example script, we will estimate target attainment for
busulfan.</p>
<p>To account for model misspecification, we will use one model to
simulate (McCune, 2014) and one model to estimate (Shukla, 2020). This
is a simplified version of a <a href="https://link.springer.com/article/10.1007/s10928-024-09915-w" class="external-link">published
study</a> in which we compared non-compartmental analysis (NCA) with MAP
Bayesian estimation for AUC-guided busulfan dosing.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mipdtrial</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">pkbusulfanmccune</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">PKPDsim</span><span class="fu">::</span><span class="fu"><a href="https://insightrx.github.io/PKPDsim/reference/install_default_literature_model.html" class="external-link">install_default_literature_model</a></span><span class="op">(</span><span class="st">"pk_busulfan_mccune"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pkbusulfanmccune</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">pkbusulfanshukla</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">PKPDsim</span><span class="fu">::</span><span class="fu"><a href="https://insightrx.github.io/PKPDsim/reference/install_default_literature_model.html" class="external-link">install_default_literature_model</a></span><span class="op">(</span><span class="st">"pk_busulfan_shukla"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pkbusulfanshukla</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># For example data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">NHANES</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For data handling/plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="define-simulation-parameters">1. Define simulation parameters<a class="anchor" aria-label="anchor" href="#define-simulation-parameters"></a>
</h2>
<p>In this simple trial, patients will be dosed once per day for four
days, with 4 levels collected per day, at 3.5, 4, 6 and 8 hours
post-dose. We will adjust doses 2, 3, and 4 to achieve a target
cumulative AUC of 90 by t = 192 hours.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tdm_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.5</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">24</span>, <span class="fl">48</span>, <span class="fl">72</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">adjust_at_dose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_target_object.html">create_target_object</a></span><span class="op">(</span></span>
<span>  targettype <span class="op">=</span> <span class="st">"cum_auc"</span>, </span>
<span>  targetvalue <span class="op">=</span> <span class="fl">90</span> <span class="op">*</span> <span class="fl">1000</span>       <span class="co"># unit conversion</span></span>
<span><span class="op">)</span></span>
<span><span class="va">auc_times</span> <span class="op">&lt;-</span> <span class="fl">192</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-a-set-of-digital-patient-covariates">2. Create a set of digital patient covariates<a class="anchor" aria-label="anchor" href="#create-a-set-of-digital-patient-covariates"></a>
</h2>
<p>We will use the NHANES data set for covariate distributions. This is
a data set of five thousand individuals collected by the US National
Center for Health Statistics. See package documentation for more
details.</p>
<p>We will also use the <code>dplyr</code> package for some basic data
processing. Since every data set is un-tidy in its own way (“Tidy
datasets are all alike, but every messy dataset is messy in its own
way.” –– <a href="https://r4ds.had.co.nz/tidy-data.html" class="external-link">Hadley
Wickham</a>), data cleaning should be handled outside of the
<code>mipdtrial</code> tools. The functions expect all patient
covariates to be numeric.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">NHANES</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/NHANES/man/NHANES.html" class="external-link">NHANES</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># take just the first record per patient</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert columns to numeric</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Gender</span> <span class="op">==</span> <span class="st">"male"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># as defined in models</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">Gender</span>, <span class="va">Age</span>, <span class="va">Weight</span>, <span class="va">Height</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># include only patients with all information available</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Gender</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Weight</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Height</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Age</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The next step is to make sure we have all the covariates we need.
Busulfan has a known time-dependent relationship with clearance, and so
the McCune model takes a covariate that indicates at what time this
relationship should start (T_CL_EFF; useful for test doses that should
not impact busulfan clearance). We will set this to zero for all
patients. The Shukla model also takes conditioning regimen as a
covariate, since co-medication with Clofarabine and Fludarabine was
associated with a change in clearance (REGI). We will also set this to
zero for all patients.</p>
<p>Other models might require fat-free mass or other calculated
covariates. This would be a good time to do that sort of processing on
your data set!</p>
<p>You may also need to convert between units (height in m to cm, for
example.)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">$</span><span class="va">T_CL_EFF</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">REGI</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>Here are the first few rows of our data set:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;      ID Gender   Age Weight Height T_CL_EFF  REGI</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">51</span>624      1    34   87.4   165.        0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="text-decoration: underline;">51</span>625      1     4   17     105.        0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="text-decoration: underline;">51</span>630      0    49   86.7   168.        0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> <span style="text-decoration: underline;">51</span>638      1     9   29.8   133.        0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> <span style="text-decoration: underline;">51</span>646      1     8   35.2   131.        0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> <span style="text-decoration: underline;">51</span>647      0    45   75.7   167.        0     0</span></span></code></pre></div>
<p>We will also only look at the first 10 patients in our data set, in
the interest of speed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">ID</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-model-definitions">3. Load model definitions<a class="anchor" aria-label="anchor" href="#load-model-definitions"></a>
</h2>
<p>We need to define the model parameters and variability terms for our
simulation. For this study, we will use the ones defined in the
models.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up simulation model ("true")</span></span>
<span><span class="va">model_sim</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanmccune</span><span class="fu">::</span><span class="fu">model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">parameters_sim</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanmccune</span><span class="fu">::</span><span class="fu">parameters</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">omega_sim</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanmccune</span><span class="fu">::</span><span class="fu">omega_matrix</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ruv_sim</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanmccune</span><span class="fu">::</span><span class="fu">ruv</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up estimation model (model for MIPD)</span></span>
<span><span class="va">model_est</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanshukla</span><span class="fu">::</span><span class="fu">model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">parameters_est</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanshukla</span><span class="fu">::</span><span class="fu">parameters</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">omega_est</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanshukla</span><span class="fu">::</span><span class="fu">omega_matrix</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ruv_est</span> <span class="op">&lt;-</span> <span class="fu">pkbusulfanshukla</span><span class="fu">::</span><span class="fu">ruv</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We also need to link the covariates in our data set to the covariates
expected in the model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># check which covariates are required for your model using </span></span>
<span><span class="co"># `attr(model_sim, "covariates")`</span></span>
<span></span>
<span><span class="co"># check which covariates are in your data set using `colnames(dat)`</span></span>
<span><span class="va">cov_mapping</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  AGE <span class="op">=</span> <span class="st">"Age"</span>, </span>
<span>  WT <span class="op">=</span> <span class="st">"Weight"</span>, </span>
<span>  HT <span class="op">=</span> <span class="st">"Height"</span>, </span>
<span>  SEX <span class="op">=</span> <span class="st">"Gender"</span>,</span>
<span>  T_CL_EFF <span class="op">=</span> <span class="st">"T_CL_EFF"</span>,</span>
<span>  REGI <span class="op">=</span> <span class="st">"REGI"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="initialize-output-metrics-of-interest">4. Initialize output metrics of interest<a class="anchor" aria-label="anchor" href="#initialize-output-metrics-of-interest"></a>
</h2>
<p>We want to record both “true” cumulative AUC and estimated cumulative
AUC, along with patient identifiers (i.e., id). We will pre-populate a
data frame rather than iteratively binding rows, since that is more
performant.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="va">ids</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  true_auc <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>  est_auc <span class="op">=</span> <span class="cn">NA_real_</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulate-a-trial">5. Simulate a trial!<a class="anchor" aria-label="anchor" href="#simulate-a-trial"></a>
</h2>
<p>Each patient will start at a dose of 3.2 mg/kg body weight. We will
then use <code><a href="../reference/dose_grid_search.html">mipdtrial::dose_grid_search</a></code> to optimize doses to
attain a target of 90 mg*h/L.</p>
<p>For inter-individual variability terms, we will use the
inter-individual variability described by our “true” model, since this
should reflect the “true” distribution in patient pharmacokinetics.
Later, we will estimate the individual PK parameters using our
estimation model and the measured TDMs we “collect”.</p>
<p>For residual error terms, we will use the residual error of our
“true” model, since this is supposed to reflect the “true” unexplained
error (assay error, etc.). This function creates a data frame of error
to add to each “true” simulated concentration to produced a measured
therapeutic drug monitoring sample.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="co"># important for reproducibility</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">ids</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># get patient covariates</span></span>
<span>  <span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_cov_object.html">create_cov_object</a></span><span class="op">(</span></span>
<span>    <span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>,<span class="op">]</span>,</span>
<span>    mapping <span class="op">=</span> <span class="va">cov_mapping</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># create initial dosing regimen (see PKPDsim::new_regimen for more info)</span></span>
<span>  <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">PKPDsim</span><span class="fu">::</span><span class="fu"><a href="https://insightrx.github.io/PKPDsim/reference/new_regimen.html" class="external-link">new_regimen</a></span><span class="op">(</span></span>
<span>    amt <span class="op">=</span> <span class="fl">3.2</span> <span class="op">*</span> <span class="va">covs</span><span class="op">$</span><span class="va">WT</span><span class="op">$</span><span class="va">value</span>, <span class="co"># we will update this each "day" of the trial.</span></span>
<span>    interval <span class="op">=</span> <span class="fl">24</span>,</span>
<span>    n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    t_inf <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"infusion"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># randomly draw individual PK parameters</span></span>
<span>  <span class="va">pars_true_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_variability.html">generate_iiv</a></span><span class="op">(</span></span>
<span>    sim_model <span class="op">=</span> <span class="va">model_sim</span>,</span>
<span>    omega <span class="op">=</span> <span class="va">omega_sim</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">parameters_sim</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">treatment_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_and_adjust_by_dose.html">sample_and_adjust_by_dose</a></span><span class="op">(</span></span>
<span>    adjust_at_dose <span class="op">=</span> <span class="va">adjust_at_dose</span>, </span>
<span>    tdm_times <span class="op">=</span> <span class="va">tdm_times</span>,</span>
<span>    regimen <span class="op">=</span> <span class="va">reg</span>,</span>
<span>    covariates <span class="op">=</span> <span class="va">covs</span>,</span>
<span>    pars_true_i <span class="op">=</span> <span class="va">pars_true_i</span>,</span>
<span>    sim_model <span class="op">=</span> <span class="va">model_sim</span>,</span>
<span>    sim_ruv <span class="op">=</span> <span class="va">ruv_sim</span>,</span>
<span>    est_model <span class="op">=</span> <span class="va">model_est</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">parameters_est</span>,</span>
<span>    omega <span class="op">=</span> <span class="va">omega_est</span>,</span>
<span>    ruv <span class="op">=</span> <span class="va">ruv_est</span>,</span>
<span>    target_time <span class="op">=</span> <span class="va">auc_times</span>,</span>
<span>    target <span class="op">=</span> <span class="va">target</span>,</span>
<span>    dose_optimization_method <span class="op">=</span> <span class="va">dose_adjust_map</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># extract metrics of interest</span></span>
<span>  <span class="va">results</span><span class="op">$</span><span class="va">true_auc</span><span class="op">[</span><span class="va">results</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_auc_from_regimen.html">calc_auc_from_regimen</a></span><span class="op">(</span></span>
<span>    regimen <span class="op">=</span> <span class="va">treatment_summary</span><span class="op">$</span><span class="va">final_regimen</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">pars_true_i</span>, <span class="co"># true patient parameters</span></span>
<span>    model <span class="op">=</span> <span class="va">model_sim</span>,</span>
<span>    target_time <span class="op">=</span> <span class="va">auc_times</span>,</span>
<span>    covariates <span class="op">=</span> <span class="va">covs</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">final_parameters</span> <span class="op">&lt;-</span> <span class="va">treatment_summary</span><span class="op">$</span><span class="va">additional_info</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">treatment_summary</span><span class="op">$</span><span class="va">additional_info</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">results</span><span class="op">$</span><span class="va">est_auc</span><span class="op">[</span><span class="va">results</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_auc_from_regimen.html">calc_auc_from_regimen</a></span><span class="op">(</span></span>
<span>    regimen <span class="op">=</span> <span class="va">treatment_summary</span><span class="op">$</span><span class="va">final_regimen</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">final_parameters</span>, <span class="co"># estimated patient PK</span></span>
<span>    model <span class="op">=</span> <span class="va">model_est</span>,</span>
<span>    target_time <span class="op">=</span> <span class="va">auc_times</span>,</span>
<span>    covariates <span class="op">=</span> <span class="va">covs</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here are the first few rows of our simulation results:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="co">#&gt;      id iter  true_auc  est_auc</span></span>
<span><span class="co">#&gt; 1 51624    1  83063.85 90006.79</span></span>
<span><span class="co">#&gt; 2 51625    1 103788.19 89998.38</span></span>
<span><span class="co">#&gt; 3 51630    1  83271.64 90045.76</span></span>
<span><span class="co">#&gt; 4 51638    1  95389.50 89999.14</span></span>
<span><span class="co">#&gt; 5 51646    1  82884.90 89965.09</span></span>
<span><span class="co">#&gt; 6 51647    1 104570.85 89964.21</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="analyze-results">6. Analyze results<a class="anchor" aria-label="anchor" href="#analyze-results"></a>
</h2>
<p>How well did our patients get to target? It looks like we estimated
that target attainment would be very high (all patients have an AUC very
close to 90 mg*h/L), but “true” AUC was higher than that due to some
model misspecification!</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">true_auc</span>, <span class="va">est_auc</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"auc_type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"auc"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">auc_type</span>, y <span class="op">=</span> <span class="va">auc</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">90</span>, color <span class="op">=</span> <span class="st">"navyblue"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Cumulative AUC (mg\u00B7h/L)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"AUC type"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="busulfan_mipd_files/figure-html/unnamed-chunk-13-1.png" width="192"></p>
<p>Even with some model misspecification, target attainment (within 20%
of target AUC) was still high:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_attainment</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    ontarget <span class="op">=</span> <span class="fu"><a href="../reference/is_on_target.html">is_on_target</a></span><span class="op">(</span><span class="va">true_auc</span>,  <span class="va">target</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>proportion_ontarget <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ontarget</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">proportion_ontarget</span><span class="op">)</span></span>
<span></span>
<span><span class="va">target_attainment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">target_attainment</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span></span></code></pre></div>
<p>Overall, 90% of patients had a “true” AUC of 90 mg*h/L.</p>
<p>For an in-depth analysis of how differences between these two models
impact target attainment, see <a href="https://link.springer.com/article/10.1007/s10928-024-09915-w" class="external-link">Hughes
et al., <em>J PKPD</em> (2024)</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jasmine Hughes, InsightRX.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
